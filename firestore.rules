rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read and write their own progress data
    // Admin can read all user docs for the contacts/admin page
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || request.auth.token.email == 'willlinnii@gmail.com');
      allow write: if request.auth != null && request.auth.uid == userId;

      match /progress/{sectionId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      match /meta/{docId} {
        // Secrets doc: owner-only read/write (API keys, etc.)
        allow read, write: if docId == 'secrets'
          && request.auth != null
          && request.auth.uid == userId;

        // Usage doc: owner can read, server-only writes (via Admin SDK)
        allow read: if docId == 'usage'
          && request.auth != null
          && request.auth.uid == userId;
        allow write: if docId == 'usage' && false;

        // All other meta docs: any auth user can read (player cards, opponent search), owner can write
        allow read: if docId != 'secrets' && docId != 'usage' && request.auth != null;
        allow write: if docId != 'secrets' && docId != 'usage' && request.auth != null && request.auth.uid == userId;
      }

      match /writings/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      match /teacher-courses/{courseId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Vault visibility for story cards is enforced client-side and
      // server-side via Admin SDK. Firestore query rules can't mix
      // per-doc visibility checks with `in`/collection queries.
      match /story-cards/{cardId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      match /story-reveals/{otherUid} {
        allow write: if request.auth != null && request.auth.uid == userId;
        allow read: if request.auth != null
          && (request.auth.uid == userId || request.auth.uid == otherUid);
      }
    }

    // Site-users collection — admin can read all, written by auth-sync server function
    match /site-users/{userId} {
      allow read: if request.auth != null && request.auth.token.email == 'willlinnii@gmail.com';
      allow write: if false;
    }

    // API keys reverse lookup — server-only (Admin SDK), no client access
    match /api-keys/{keyHash} {
      allow read, write: if false;
    }

    // Handle uniqueness index — read-only for clients, written by server via Admin SDK
    match /handles/{handle} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // Match documents for multiplayer games
    match /matches/{matchId} {
      allow read: if request.auth != null && request.auth.uid in resource.data.playerUids;
      allow create: if request.auth != null;
      allow update: if request.auth != null && request.auth.uid in resource.data.playerUids;
      allow delete: if false;

      match /chat/{msgId} {
        allow read, create: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.playerUids;
        allow update, delete: if false;
      }
    }

    // Course definitions are readable by all authenticated users
    match /courses/{courseId} {
      allow read: if request.auth != null;
      // Only admin can write (via Admin SDK on server)
      allow write: if false;
    }

    // Guild applications — admin read-only, server-written
    match /guild-applications/{appId} {
      allow read: if request.auth != null && request.auth.token.email == 'willlinnii@gmail.com';
      allow write: if false;
    }

    // Guild directory — readable by all auth users, server-written only
    match /guild-directory/{memberId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // Legacy mentor collections (kept during migration)
    match /mentor-applications/{appId} {
      allow read: if request.auth != null && request.auth.token.email == 'willlinnii@gmail.com';
      allow write: if false;
    }
    match /mentor-directory/{mentorId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // Partner applications — admin read-only, server-written
    match /partner-applications/{appId} {
      allow read: if request.auth != null && request.auth.token.email == 'willlinnii@gmail.com';
      allow write: if false;
    }

    // Partner directory — readable by all auth users, server-written only
    match /partner-directory/{partnerId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // Partner memberships — readable by partner owner, representative, or admin; server-written only
    match /partner-memberships/{membershipId} {
      allow read: if request.auth != null
        && (request.auth.uid == resource.data.partnerUid
            || request.auth.uid == resource.data.representativeUid
            || request.auth.token.email == 'willlinnii@gmail.com');
      allow write: if false;
    }

    // Guild pairings — readable by guild member, student, or admin; server-written only
    match /guild-pairings/{pairingId} {
      allow read: if request.auth != null
        && (request.auth.uid == resource.data.guildMemberUid
            || request.auth.uid == resource.data.mentorUid
            || request.auth.uid == resource.data.studentUid
            || request.auth.token.email == 'willlinnii@gmail.com');
      allow write: if false;
    }

    // Legacy mentor pairings (kept during migration)
    match /mentor-pairings/{pairingId} {
      allow read: if request.auth != null
        && (request.auth.uid == resource.data.mentorUid
            || request.auth.uid == resource.data.studentUid
            || request.auth.token.email == 'willlinnii@gmail.com');
      allow write: if false;
    }

    // Guild forum posts — readable by any auth user, server-written only
    match /guild-posts/{postId} {
      allow read: if request.auth != null;
      allow write: if false;

      match /replies/{replyId} {
        allow read: if request.auth != null;
        allow write: if false;
      }
    }

    // Guild votes — readable by any auth user, server-written only
    match /guild-votes/{voteId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // Consulting requests — readable by consultant, requester, or admin; server-written only
    match /consulting-requests/{requestId} {
      allow read: if request.auth != null
        && (request.auth.uid == resource.data.consultantUid
            || request.auth.uid == resource.data.requesterUid
            || request.auth.token.email == 'willlinnii@gmail.com');
      allow write: if false;
    }

    // Consulting engagements — readable by client, practitioner, or admin; server-written only
    match /consulting-engagements/{engagementId} {
      allow read: if request.auth != null
        && (request.auth.uid == resource.data.clientUid
            || request.auth.uid == resource.data.practitionerUid
            || request.auth.token.email == 'willlinnii@gmail.com');
      allow write: if false;

      match /sessions/{sessionId} {
        allow read: if request.auth != null
          && (request.auth.uid == get(/databases/$(database)/documents/consulting-engagements/$(engagementId)).data.clientUid
              || request.auth.uid == get(/databases/$(database)/documents/consulting-engagements/$(engagementId)).data.practitionerUid
              || request.auth.token.email == 'willlinnii@gmail.com');
        allow write: if false;
      }
    }

    // Community feed (legacy top-level) — any authenticated user can read/create; only author can update/delete
    match /feed/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null
        && request.auth.uid == resource.data.createdBy;
    }

    // ===== Family groups =====
    match /families/{familyId} {
      // Members can read; any auth user can create; members can update
      allow read: if request.auth != null
        && request.auth.uid in resource.data.memberUids;
      allow create: if request.auth != null;
      allow update: if request.auth != null
        && request.auth.uid in resource.data.memberUids;
      allow delete: if false;

      // Subcollections — only family members can read/write
      match /traditions/{traditionId} {
        allow read, create: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/families/$(familyId)).data.memberUids;
        allow update, delete: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/families/$(familyId)).data.memberUids;
      }

      match /creations/{creationId} {
        allow read, create: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/families/$(familyId)).data.memberUids;
        allow update, delete: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/families/$(familyId)).data.memberUids;
      }

      match /storybook/{memberId} {
        allow read, write: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/families/$(familyId)).data.memberUids;
      }

      match /feed/{postId} {
        allow read, create: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/families/$(familyId)).data.memberUids;
        allow update: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/families/$(familyId)).data.memberUids;
        allow delete: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/families/$(familyId)).data.memberUids
          && request.auth.uid == resource.data.createdBy;
      }

      match /genealogy/{personId} {
        allow read, create: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/families/$(familyId)).data.memberUids;
        allow update, delete: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/families/$(familyId)).data.memberUids;
      }
    }

    // ===== Curated products (admin + approved curators) =====
    match /curatedProducts/{productId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.email == 'willlinnii@gmail.com';
      allow create: if request.auth != null
        && get(/databases/$(database)/documents/users/$(request.auth.uid)/meta/profile).data.curatorApproved == true
        && request.resource.data.curatedBy == request.auth.uid;
    }

    // ===== Match profiles (story matching) =====
    match /match-profiles/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;

      match /comparisons/{otherUid} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if false;
      }
    }

    // ===== Match requests (story matching) =====
    match /match-requests/{requestId} {
      allow read: if request.auth != null
        && (request.auth.uid == resource.data.senderUid
            || request.auth.uid == resource.data.recipientUid);
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.senderUid;
      allow update: if request.auth != null
        && request.auth.uid == resource.data.recipientUid;
      allow delete: if request.auth != null
        && (request.auth.uid == resource.data.senderUid
            || request.auth.uid == resource.data.recipientUid);
    }

    // ===== Match conversations (messaging between mutual matches) =====
    match /match-conversations/{conversationId} {
      allow read, write: if request.auth != null
        && request.auth.uid in resource.data.participantUids;
      allow create: if request.auth != null
        && request.auth.uid in request.resource.data.participantUids;

      match /messages/{msgId} {
        allow read, create: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/match-conversations/$(conversationId)).data.participantUids;
        allow update, delete: if false;
      }
    }

    // ===== Friend conversations (1-to-1 friend messaging, group-ready) =====
    match /friend-conversations/{conversationId} {
      allow read, write: if request.auth != null
        && request.auth.uid in resource.data.participantUids;
      allow create: if request.auth != null
        && request.auth.uid in request.resource.data.participantUids;

      match /messages/{msgId} {
        allow read, create: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/friend-conversations/$(conversationId)).data.participantUids;
        allow update, delete: if false;
      }
    }

    // ===== Fellowship posts (social feed) =====
    // Vault/family/profile visibility is enforced client-side.
    // Firestore `in` queries break if per-doc rules reject any result,
    // so we keep read open and filter in the client.
    match /fellowship-posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.authorUid;
      allow update: if request.auth != null;
      allow delete: if request.auth != null && request.auth.uid == resource.data.authorUid;
    }

    // ===== Community posts (individual + group feed) =====
    match /community-posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.createdBy;
      allow update: if request.auth != null;
      allow delete: if request.auth != null && request.auth.uid == resource.data.createdBy;

      match /replies/{replyId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null
          && request.auth.uid == request.resource.data.createdBy;
        allow delete: if request.auth != null
          && request.auth.uid == resource.data.createdBy;
      }
    }

    // ===== Friend requests (1-to-1) =====
    match /friend-requests/{requestId} {
      allow read: if request.auth != null
        && (request.auth.uid == resource.data.senderUid
            || request.auth.uid == resource.data.recipientUid);
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.senderUid;
      allow update: if request.auth != null
        && (request.auth.uid == resource.data.senderUid
            || request.auth.uid == resource.data.recipientUid);
      allow delete: if request.auth != null
        && (request.auth.uid == resource.data.senderUid
            || request.auth.uid == resource.data.recipientUid);
    }

    // ===== Friend groups =====
    match /friendGroups/{groupId} {
      // Members can read; any auth user can create; members can update
      allow read: if request.auth != null
        && request.auth.uid in resource.data.memberUids;
      allow create: if request.auth != null;
      allow update: if request.auth != null
        && request.auth.uid in resource.data.memberUids;
      allow delete: if false;

      // Subcollections — only group members can read/write
      match /traditions/{traditionId} {
        allow read, create: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/friendGroups/$(groupId)).data.memberUids;
        allow update, delete: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/friendGroups/$(groupId)).data.memberUids;
      }

      match /creations/{creationId} {
        allow read, create: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/friendGroups/$(groupId)).data.memberUids;
        allow update, delete: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/friendGroups/$(groupId)).data.memberUids;
      }

      match /storybook/{memberId} {
        allow read, write: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/friendGroups/$(groupId)).data.memberUids;
      }

      match /feed/{postId} {
        allow read, create: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/friendGroups/$(groupId)).data.memberUids;
        allow update: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/friendGroups/$(groupId)).data.memberUids;
        allow delete: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/friendGroups/$(groupId)).data.memberUids
          && request.auth.uid == resource.data.createdBy;
      }
    }
  }
}
